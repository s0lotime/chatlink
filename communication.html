<!DOCTYPE html>
<html>
<head>
  <title>Chatlink Video Call</title>
</head>
<body>
  <h1>Chatlink WebRTC Call</h1>

  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <input id="targetId" placeholder="Target client ID" />
  <button onclick="startCall()">Start Call</button>

  <script>
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    const socket = new WebSocket("wss://chatlink.space/messagerouting/call/connection?room=default");

    let localStream;
    let peer;
    let myId;
    let targetId;

    socket.addEventListener("open", async () => {
      console.log("WebSocket connected");

      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;

      peer = createPeer();
      localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
    });

    socket.addEventListener("message", async (event) => {
      const msg = JSON.parse(event.data);
      console.log("Message:", msg);

      if (msg.type === "welcome") {
        myId = msg.id;
        console.log("My ID:", myId);
      }

      if (msg.type === "offer") {
        targetId = msg.from;
        await peer.setRemoteDescription(new RTCSessionDescription(msg.payload));
        const answer = await peer.createAnswer();
        await peer.setLocalDescription(answer);
        sendMessage(targetId, "answer", answer);
      }

      if (msg.type === "answer") {
        await peer.setRemoteDescription(new RTCSessionDescription(msg.payload));
      }

      if (msg.type === "ice") {
        try {
          await peer.addIceCandidate(new RTCIceCandidate(msg.payload));
        } catch (e) {
          console.error("Error adding ICE candidate:", e);
        }
      }
    });

    function sendMessage(to, type, payload) {
      socket.send(JSON.stringify({ to, type, payload }));
    }

    function createPeer() {
      const pc = new RTCPeerConnection({
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" }
        ]
      });

      pc.onicecandidate = (event) => {
        if (event.candidate && targetId) {
          sendMessage(targetId, "ice", event.candidate);
        }
      };

      pc.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
      };

      return pc;
    }

    async function startCall() {
      targetId = document.getElementById("targetId").value.trim();
      if (!targetId) return alert("Enter target ID");

      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);
      sendMessage(targetId, "offer", offer);
    }
  </script>
</body>
</html>
