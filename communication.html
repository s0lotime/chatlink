<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Minimal WebRTC Video Call (Manual Signaling)</title>
</head>
<body>
  <h1>WebRTC Manual Signaling Video Call Demo</h1>

  <video id="localVideo" autoplay muted playsinline style="width: 45%; border: 1px solid black;"></video>
  <video id="remoteVideo" autoplay playsinline style="width: 45%; border: 1px solid black;"></video>
  
  <br/>

  <button id="startCall">Start Call (Create Offer)</button>
  <button id="answerCall">Answer Call (Create Answer)</button>
  
  <h3>Local SDP (Copy this to remote peer)</h3>
  <textarea id="localSDP" cols="60" rows="10" readonly></textarea>

  <h3>Remote SDP (Paste from remote peer)</h3>
  <textarea id="remoteSDP" cols="60" rows="10"></textarea>
  <button id="setRemoteSDP">Set Remote SDP</button>

  <h3>Local ICE Candidates (Copy these to remote peer)</h3>
  <textarea id="localICE" cols="60" rows="5" readonly></textarea>

  <h3>Remote ICE Candidates (Paste from remote peer)</h3>
  <textarea id="remoteICE" cols="60" rows="5"></textarea>
  <button id="addRemoteICE">Add Remote ICE Candidates</button>

  <h3>Connection status: <span id="status">Not connected</span></h3>

  <script>
    let pc = null;
    let localStream = null;
    let localICECandidates = [];

    const iceServers = [{ urls: "stun:stun.l.google.com:19302" }];

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const startCallBtn = document.getElementById('startCall');
    const answerCallBtn = document.getElementById('answerCall');
    const localSDPTextarea = document.getElementById('localSDP');
    const remoteSDPTextarea = document.getElementById('remoteSDP');
    const setRemoteSDPBtn = document.getElementById('setRemoteSDP');
    const localICETextarea = document.getElementById('localICE');
    const remoteICETextarea = document.getElementById('remoteICE');
    const addRemoteICEBtn = document.getElementById('addRemoteICE');
    const statusSpan = document.getElementById('status');

    async function createPeerConnection() {
      pc = new RTCPeerConnection({ iceServers });

      pc.onicecandidate = event => {
        if (event.candidate) {
          localICECandidates.push(event.candidate);
          localICETextarea.value = JSON.stringify(localICECandidates, null, 2);
        }
      };

      pc.onconnectionstatechange = () => {
        statusSpan.textContent = pc.connectionState;
      };

      pc.ontrack = event => {
        remoteVideo.srcObject = event.streams[0];
      };

      // Get user media (audio + video)
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;

      // Add all local tracks to peer connection
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    }

    startCallBtn.onclick = async () => {
      await createPeerConnection();

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      localSDPTextarea.value = JSON.stringify(pc.localDescription);
      statusSpan.textContent = "Offer created. Send SDP to remote peer.";
    };

    answerCallBtn.onclick = async () => {
      await createPeerConnection();
      statusSpan.textContent = "Waiting for remote SDP...";
    };

    setRemoteSDPBtn.onclick = async () => {
      if (!pc) {
        alert("Create a peer connection first (start or answer)");
        return;
      }
      try {
        const remoteDesc = JSON.parse(remoteSDPTextarea.value);
        await pc.setRemoteDescription(new RTCSessionDescription(remoteDesc));

        if (remoteDesc.type === "offer") {
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          localSDPTextarea.value = JSON.stringify(pc.localDescription);
          statusSpan.textContent = "Answer created and sent. Waiting for ICE...";
        } else {
          statusSpan.textContent = "Remote SDP set. Waiting for ICE...";
        }
      } catch (e) {
        alert("Invalid SDP JSON");
      }
    };

    addRemoteICEBtn.onclick = async () => {
      if (!pc) {
        alert("Create a peer connection first");
        return;
      }
      try {
        const candidates = JSON.parse(remoteICETextarea.value);
        for (const c of candidates) {
          await pc.addIceCandidate(new RTCIceCandidate(c));
        }
        statusSpan.textContent = "Remote ICE candidates added.";
      } catch (e) {
        alert("Invalid ICE candidate JSON");
      }
    };
  </script>
</body>
</html>
