<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Minimal WebRTC Manual Signaling</title>
</head>
<body>
  <h1>WebRTC Manual Signaling Demo</h1>

  <button id="startCall">Start Call (Create Offer)</button>
  <button id="answerCall">Answer Call (Create Answer)</button>
  
  <h3>Local SDP (Copy this to remote peer)</h3>
  <textarea id="localSDP" cols="60" rows="10" readonly></textarea>

  <h3>Remote SDP (Paste from remote peer)</h3>
  <textarea id="remoteSDP" cols="60" rows="10"></textarea>
  <button id="setRemoteSDP">Set Remote SDP</button>

  <h3>Local ICE Candidates (Copy these to remote peer)</h3>
  <textarea id="localICE" cols="60" rows="5" readonly></textarea>

  <h3>Remote ICE Candidates (Paste from remote peer)</h3>
  <textarea id="remoteICE" cols="60" rows="5"></textarea>
  <button id="addRemoteICE">Add Remote ICE Candidates</button>

  <h3>Connection status: <span id="status">Not connected</span></h3>

  <script>
    let pc = null;
    let localICECandidates = [];

    const iceServers = [
      { urls: "stun:stun.l.google.com:19302" }
      // Add TURN servers here later if you get one
    ];

    const startCallBtn = document.getElementById('startCall');
    const answerCallBtn = document.getElementById('answerCall');
    const localSDPTextarea = document.getElementById('localSDP');
    const remoteSDPTextarea = document.getElementById('remoteSDP');
    const setRemoteSDPBtn = document.getElementById('setRemoteSDP');
    const localICETextarea = document.getElementById('localICE');
    const remoteICETextarea = document.getElementById('remoteICE');
    const addRemoteICEBtn = document.getElementById('addRemoteICE');
    const statusSpan = document.getElementById('status');

    function createPeerConnection() {
      pc = new RTCPeerConnection({ iceServers });

      pc.onicecandidate = event => {
        if (event.candidate) {
          localICECandidates.push(event.candidate);
          localICETextarea.value = JSON.stringify(localICECandidates, null, 2);
        }
      };

      pc.onconnectionstatechange = () => {
        statusSpan.textContent = pc.connectionState;
      };

      // For demo: create dummy data channel to start connection
      const channel = pc.createDataChannel("chat");
      channel.onopen = () => {
        console.log("Data channel open");
      };
      channel.onmessage = e => {
        console.log("Message from remote:", e.data);
      };
    }

    startCallBtn.onclick = async () => {
      createPeerConnection();

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      localSDPTextarea.value = JSON.stringify(pc.localDescription);
      statusSpan.textContent = "Offer created. Send SDP to remote peer.";
    };

    answerCallBtn.onclick = async () => {
      createPeerConnection();
      statusSpan.textContent = "Waiting for remote SDP...";
    };

    setRemoteSDPBtn.onclick = async () => {
      if (!pc) {
        alert("Create a peer connection first (start or answer)");
        return;
      }
      try {
        const remoteDesc = JSON.parse(remoteSDPTextarea.value);
        await pc.setRemoteDescription(new RTCSessionDescription(remoteDesc));

        if (remoteDesc.type === "offer") {
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          localSDPTextarea.value = JSON.stringify(pc.localDescription);
          statusSpan.textContent = "Answer created and sent. Waiting for ICE...";
        } else {
          statusSpan.textContent = "Remote SDP set. Waiting for ICE...";
        }
      } catch (e) {
        alert("Invalid SDP JSON");
      }
    };

    addRemoteICEBtn.onclick = async () => {
      if (!pc) {
        alert("Create a peer connection first");
        return;
      }
      try {
        const candidates = JSON.parse(remoteICETextarea.value);
        for (const c of candidates) {
          await pc.addIceCandidate(new RTCIceCandidate(c));
        }
        statusSpan.textContent = "Remote ICE candidates added.";
      } catch (e) {
        alert("Invalid ICE candidate JSON");
      }
    };
  </script>
</body>
</html>
