<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebRTC Video Call</title>
  <style>
    video {
      width: 45%;
      margin: 1%;
      border: 2px solid #ccc;
      border-radius: 8px;
      display: block;
      margin: 0 auto;
    }
    body {
      font-family: sans-serif;
      text-align: center;
    }
  </style>
</head>
<body>
  <h2>WebRTC Video Call</h2>
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>
  <br><br>
  <button id="start">Start Call</button>

  <script>
    const callId = new URLSearchParams(location.search).get("call");
    if (!callId) {
      alert("Add ?call=CALLID to the URL");
      throw new Error("Missing call ID");
    }

    const ws = new WebSocket(`wss://${location.host}/messagerouting/websocket/connection?call=${callId}`);
    let wsReady = new Promise(resolve => {
      ws.onopen = () => {
        console.log("WebSocket connected");
        resolve();
      };
    });

    let pc, localStream;
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    let iceCandidatesQueue = []; // Queue to store ICE candidates until the remote description is set

    // WebSocket message handler
    ws.onmessage = async (event) => {
      const msg = JSON.parse(event.data);

      if (!pc) await setup();

      if (msg.type === "offer") {
        console.log("Received offer, setting remote description...");
        await pc.setRemoteDescription(new RTCSessionDescription(msg));

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await wsReady;
        ws.send(JSON.stringify(answer));
      } else if (msg.type === "answer") {
        console.log("Received answer, setting remote description...");
        await pc.setRemoteDescription(new RTCSessionDescription(msg));
      } else if (msg.candidate) {
        console.log("Received ICE candidate...");
        // Queue the candidate if remote description is not set yet
        if (pc.remoteDescription) {
          await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
        } else {
          iceCandidatesQueue.push(msg.candidate);
        }
      }
    };

    // Setup WebRTC connection
    async function setup() {
      if (pc) return; // Prevent re-initialization

      console.log("Setting up WebRTC connection...");
      // Get media stream
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
      } catch (err) {
        console.error("Error accessing media devices.", err);
        alert("Could not access media devices. Make sure you have granted permission.");
        return;
      }

      // Initialize peer connection
      pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      // Handle receiving remote tracks
      pc.ontrack = (event) => {
        console.log("Track received:", event);
        const remoteStream = event.streams[0];
        remoteVideo.srcObject = remoteStream;
      };

      // Add local tracks to the peer connection
      localStream.getTracks().forEach(track => {
        pc.addTrack(track, localStream);
      });

      // ICE Candidate handling
      pc.onicecandidate = (e) => {
        if (e.candidate && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ candidate: e.candidate }));
        }
      };

      // Process any queued ICE candidates after setting the remote description
      if (iceCandidatesQueue.length > 0) {
        for (let candidate of iceCandidatesQueue) {
          await pc.addIceCandidate(new RTCIceCandidate(candidate));
        }
        iceCandidatesQueue = []; // Clear the queue after processing
      }
    }

    // Start call button handler
    document.getElementById("start").onclick = async () => {
      await setup();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await wsReady;
      ws.send(JSON.stringify(offer));
    };
  </script>
</body>
</html>
